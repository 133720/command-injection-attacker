/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package uk.co.pentest.SHELLING;

import java.awt.BorderLayout;
import java.awt.ComponentOrientation;
import java.awt.Dimension;

import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.HierarchyEvent;
import java.awt.event.ItemEvent;
import java.awt.event.ItemListener;
import java.awt.event.KeyEvent;
import java.awt.event.KeyListener;
import java.io.PrintWriter;
import java.util.ArrayList;
import javax.swing.BoxLayout;

import javax.swing.JButton;
import javax.swing.JCheckBox;
import javax.swing.JComboBox;

import javax.swing.JLabel;
import javax.swing.JList;
import javax.swing.JOptionPane;

import javax.swing.JPanel;
import javax.swing.JScrollPane;
import javax.swing.JTextArea;
import javax.swing.ListSelectionModel;

/**
 *
 * @author ewilded
 */
public final class ShellingPanel extends JPanel {
    static String PROMPT_TITLE = "SHELLING";
    protected JComboBox targetOSCombo; 
    protected JComboBox operationModeCombo; 
    protected JComboBox feedbackChannelCombo; 
    protected JCheckBox payloadMarkingBox;
    protected JCheckBox scannerChecksBox;
    protected String targetOS="nix"; // possible values: nix,win,all
    protected JLabel command;    
    protected JLabel argument;
    protected JTextArea argumentField;        
    protected JTextArea commandField;
    protected JTextArea commandPrefixField;
    protected String byteGeneratorRange;   
    public String mode = "auto";
    public String feedbackChannel = "time"; // "DNS" is the other option atm
    public boolean scannerChecks = true; // whether to automatically extend the active scanning

    protected JTextArea logOutput;
    protected JList encodeList;

    PrintWriter stdout;

    protected void appendListData(JList list, String[] items)
    {
        ArrayList tmp = new ArrayList();

         for (int i=0; i < list.getModel().getSize(); i++) {
            String elem = (String) list.getModel().getElementAt(i);           
            tmp.add(elem);
        }
        for(String item: items)
        {
            if(!tmp.contains(item)) tmp.add(item);
        }
        list.setListData(tmp.toArray());
    }
    private void removeFromListData(JList list, String item)
    {
        ArrayList tmp = new ArrayList();

         for (int i=0; i < list.getModel().getSize(); i++) {
            String elem = (String) list.getModel().getElementAt(i); 
            if(!elem.equals(item)) tmp.add(elem);
        }
        list.setListData(tmp.toArray());
    }

    private void initiateEncodings() // same as clear, no encoding by default
    {
        String empty[] = {"None"};
        encodeList.setListData(empty);
    }

    ShellingPanel() {
        stdout = new PrintWriter(SHELLING.callbacks.getStdout(), true);
        setLayout(new BorderLayout());
        // CREATE THE PANEL SKELETON
        JPanel mainPanel = new JPanel();
        mainPanel.setLayout(new BoxLayout(mainPanel,BoxLayout.Y_AXIS));
        mainPanel.setComponentOrientation(ComponentOrientation.LEFT_TO_RIGHT);
       
        // TARGET OS SECTION START        
        JLabel targetOSLabel = new JLabel("Target OS");
        targetOSCombo = new JComboBox();
        String[] OSNames= { "Nix (default)", "Windows", "All"};
        for (String OSName : OSNames) {
            targetOSCombo.addItem(OSName);
        }
        targetOSCombo.addActionListener((ActionEvent e) -> {
            switch(targetOSCombo.getSelectedIndex())
            { 
                case 0 : { this.targetOS="nix"; break;}
                case 1 : { this.targetOS="win"; break;}
                case 2 : { this.targetOS="all"; break;}
            }
        });        
       
        // MODE SECTION
        JLabel operationModeLabel = new JLabel("Operation mode:");
        operationModeCombo = new JComboBox();
        String[] operationModes= { "Auto (default)", "Manual" };
        for (String opMode : operationModes) {
            operationModeCombo.addItem(opMode);
        }
        operationModeCombo.addActionListener((ActionEvent e) -> {
            switch(operationModeCombo.getSelectedIndex())
            { 
                case 0 : { this.mode="auto"; break;}
                case 1 : { this.mode="manual"; break;}
            }
        });                

        // Feedback channel (auto mode setting)
        JLabel feedbackChannelLabel = new JLabel("Feedback channel (auto mode only):");
        feedbackChannelCombo = new JComboBox();
        String[] feedbackChannels = { "Delay (sleep)", "DNS (collaborator)"};
        for(String feedbackChannel: feedbackChannels)
        {
            feedbackChannelCombo.addItem(feedbackChannel);
        }
        feedbackChannelCombo.addActionListener((ActionEvent e) -> {
            switch(feedbackChannelCombo.getSelectedIndex())
            { 
                case 0 : { this.feedbackChannel="time"; break;}
                case 1 : { this.feedbackChannel="DNS"; break;}
            }
        }); 
        // Prefix is now automatically set from the base payload marked in Intruder
        // not removing this code as might want to add the ability to configure additional prefixes
        //JLabel commandPrefix = new JLabel("Additional command prefix (a sample legitimate argument to the target feature, e.g. username, hostname or IP address)");
        //commandPrefixField = new JTextArea(1,15);
        //commandPrefixField.setText("a");
        //JPanel prefixPanel = new JPanel();
        //prefixPanel.add(commandPrefix);
        //prefixPanel.add(commandPrefixField);
                
        JLabel payloadMarkingLabel = new JLabel();
        payloadMarkingLabel.setText("Payload marking");
        payloadMarkingBox = new JCheckBox();
        //optimizeDocrootTraversalsBox
        payloadMarkingBox.setSelected(true);
               
        scannerChecksBox = new JCheckBox();
        scannerChecksBox.setSelected(true);
        
        scannerChecksBox.addItemListener((ItemEvent e) -> {
            if(ItemEvent.SELECTED == e.getStateChange()) {//checkbox has been selected
                scannerChecks=true;
                
            } else {
                scannerChecks=false;
            };          
        });

        JPanel otherOptionsPanel = new JPanel();
        otherOptionsPanel.setLayout(new BoxLayout(otherOptionsPanel , BoxLayout.Y_AXIS));
        otherOptionsPanel.add(payloadMarkingLabel);
        otherOptionsPanel.add(payloadMarkingBox);
        JLabel scannerLabel = new JLabel();
        scannerLabel.setText("Active Scanning");
        otherOptionsPanel.add(scannerLabel);
        otherOptionsPanel.add(scannerChecksBox);
        
        otherOptionsPanel.add(operationModeLabel);
        otherOptionsPanel.add(operationModeCombo);  
        
        otherOptionsPanel.add(feedbackChannelLabel);        
        otherOptionsPanel.add(feedbackChannelCombo);
        // OUTPUT ENCODING SECTION START
        JLabel encodeLabel = new JLabel();
        encodeLabel.setText("Output encodings to use:");
        encodeList = new JList();
        encodeList.setSelectionMode(ListSelectionModel.SINGLE_INTERVAL_SELECTION);        
        encodeList.setLayoutOrientation(JList.VERTICAL);
        encodeList.setVisibleRowCount(10);
        this.initiateEncodings();
        JScrollPane encodeListScroller = new JScrollPane(encodeList);
        encodeListScroller.setPreferredSize(new Dimension(150, 100));

        JButton encodeRemoveButton = new JButton("Remove");
        encodeRemoveButton.addActionListener((ActionEvent e) -> {                
                if(encodeList.getSelectedIndex()!=-1) removeFromListData(encodeList,(String)encodeList.getModel().getElementAt(encodeList.getSelectedIndex()));                                
                if(encodeList.getModel().getSize()==0) this.initiateEncodings();
        });        
        JButton encodeClearButton = new JButton("Clear");
        encodeClearButton.addActionListener(new ActionListener() {
            @Override
            public void actionPerformed(ActionEvent e) {
                initiateEncodings();
            }
        });        
        
        JComboBox encodingsToUse = new JComboBox();
        String[] encodeLabels= { "None (default)", "URL", "Double URL"};
        for (String encodeName : encodeLabels) {
            encodingsToUse.addItem(encodeName);
        }
        encodingsToUse.addActionListener((ActionEvent e) -> {
            switch(encodingsToUse.getSelectedIndex())
            { 
                case 0 : { 
                    this.initiateEncodings(); break;
                }
                case 1 : { String n[]={"URL"}; appendListData(encodeList,n); break;}
                case 2 : { String n[]={"Double URL"}; appendListData(encodeList,n);  break;}
            }
        });    
        
        JPanel encodingPanel = new JPanel();
        encodingPanel.add(encodeLabel);
        encodingPanel.add(encodeListScroller);
        encodingPanel.add(encodeRemoveButton);
        encodingPanel.add(encodeClearButton);
        encodingPanel.add(encodingsToUse);
        
        encodingPanel.setLayout(new BoxLayout(encodingPanel , BoxLayout.Y_AXIS)); 
        // OUTPUTE ENCODING SECTION STOP
   

        JPanel targetOSPanel = new JPanel();
        targetOSPanel.add(targetOSLabel);
        targetOSPanel.add(targetOSCombo);
        
        JPanel commandPanel = new JPanel();
        command = new JLabel("Command to use");
        commandField= new JTextArea(1,40);
        commandField.setText("nslookup"); // replaced ping with nslookup; ping is impractical with payload marking; if succeeds, the command by default will be running for ever while the server will timeout and the result won't be shown in Intruder
        // while using count flag the specify the number of packets differs between nix (-c) and windows (-n), so it's additional incompatibility to handle
        // this problem did not manifest itself on windows, as by default windows ping sends 4 packets and returns
        commandPanel.add(command);
        commandPanel.add(commandField);
        
        JPanel argumentPanel=new JPanel();
        argument = new JLabel("Command argument:");
        argumentField = new JTextArea(1,35);
        argumentField.setText("PAYLOAD_MARK.burpcollaborator.client.generated.domain.here");
        
        argumentField.addKeyListener(new KeyListener(){
            @Override
            public void keyTyped(KeyEvent e){}
            @Override 
            public void keyPressed(KeyEvent e){}
            @Override
            public void keyReleased(KeyEvent e) {
                    // if target is all/nix, it is NOT recommended to use arguments starting with numbers + without payload marking, as this will break $IFS$9NUMBER making all relevant payloads true negatives
                    if(argumentField.getText().matches("^\\d+.*$"))
                    {
                       JOptionPane.showMessageDialog(argumentField,"WARNING: It is NOT recommended to use arguments starting with numbers for nix targets (this WILL make all $IFS$9 payloads FAIL)!");
                    }
            }
        });
        
        argumentPanel.add(argument);
        argumentPanel.add(argumentField);
       
           // OPTIONS PANEL START
        JPanel optionsPanel = new JPanel();   
        optionsPanel.setLayout(new BoxLayout(optionsPanel , BoxLayout.Y_AXIS));     
        
        optionsPanel.add(targetOSPanel);                
        optionsPanel.add(commandPanel);
        optionsPanel.add(argumentPanel);
        optionsPanel.add(otherOptionsPanel);        
        optionsPanel.add(encodingPanel);

        // END OF OPTIONS PANEL

        JPanel byteGeneratorPanel = new JPanel();
        
        JLabel byteGeneratorLabel = new JLabel();
        byteGeneratorLabel.setText("Byte generator range");
      
        JComboBox byteGeneratorRangeCombo = new JComboBox();       
        String[] byteRanges = { "Non-alphanumeric", "Alphanumeric", "Non-alphanumeric printable", "Non-alphanumeric non-printable","Non-alphanumeric non-printable < 128","All"};
        for (String byteRange : byteRanges) {
            byteGeneratorRangeCombo.addItem(byteRange);
        }
        this.byteGeneratorRange="non-alpha"; // this is the default
        byteGeneratorRangeCombo.addActionListener((ActionEvent e) -> {
            switch (byteGeneratorRangeCombo.getSelectedIndex()) {
                case 0:
                {
                    ShellingPanel.this.byteGeneratorRange = "non-alpha";
                    break;
                }
                case 1:
                {
                    ShellingPanel.this.byteGeneratorRange = "alpha";           
                    break;
                }
                case 2:
                {
                    ShellingPanel.this.byteGeneratorRange = "non-alpha-print";
                    break;
                }
                case 3:
                {
                    ShellingPanel.this.byteGeneratorRange = "non-alpha-non-print";
                    break;
                }
                case 4:
                {
                    ShellingPanel.this.byteGeneratorRange = "non-alpha-non-print-low";
                }
                case 5:
                {
                    ShellingPanel.this.byteGeneratorRange = "all";
                    break;
                }
            }
        });                
        byteGeneratorPanel.add(byteGeneratorLabel);
        byteGeneratorPanel.add(byteGeneratorRangeCombo);     
        byteGeneratorPanel.setLayout(new BoxLayout(byteGeneratorPanel,BoxLayout.Y_AXIS));
                
        JPanel rightPanel = new JPanel(); // the most-right panel to hold targets and byte-generator options
        
        // ADD PANELS TO THE MAIN SHELLING PANEL        

        rightPanel.add(byteGeneratorPanel);
        mainPanel.add(optionsPanel); // first row
        mainPanel.add(rightPanel);
        
        add(mainPanel,BorderLayout.NORTH);
        addHierarchyListener((HierarchyEvent evt) -> {
            SHELLING.ShellingTab.findTab();
        });        
    }
    public void logOutput(String msg)
    {
        //this.logOutput.append(msg);
        stdout.println(msg);
    }
}
